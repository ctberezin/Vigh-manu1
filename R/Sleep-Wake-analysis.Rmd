---
title: "Sleep/Wake Analysis"
author: "Nik Bergum & Casey-Tyler Berezin"
date: "3/25/2022"
output: pdf_document
---

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)
```

```{r}
xl <- read.csv("../data/WT_McKO_combined_sleep.csv")
colnames(xl)[1] <- gsub('^...','',colnames(xl)[1])

t_wt <- xl %>%
   group_by(Transmitter, Genotype, ZT, Day) %>%
   dplyr::summarise(sum_wake = sum(Wake),
                    sum_sws = sum(SWS),
                    sum_ps = sum(PS),
                    sum_art = sum(Artifact))

t_wt$PercentWake <- (t_wt$sum_wake / (t_wt$sum_sws + t_wt$sum_wake + t_wt$sum_ps + t_wt$sum_art))
t_wt$PercentSWS <- (t_wt$sum_sws / (t_wt$sum_sws + t_wt$sum_wake + t_wt$sum_ps + t_wt$sum_art))
t_wt$PercentPS <- (t_wt$sum_ps / (t_wt$sum_sws + t_wt$sum_wake + t_wt$sum_ps + t_wt$sum_art))
t_wt$PercentArt <- ((t_wt$sum_art)/ (t_wt$sum_sws + t_wt$sum_wake + t_wt$sum_ps + t_wt$sum_art))

t_wt <- t_wt %>% dplyr::mutate(phase= ifelse(ZT>11, "dark", "light"))

t_wt$ZT <- as.factor(t_wt$ZT)


SumStatwt <- dplyr::summarise(group_by(t_wt, Genotype, ZT, phase),
n = n(),
mean_Wake = mean(PercentWake),
sd_Wake = sd(PercentWake),
se_Wake = sd_Wake/sqrt(n),
mean_SWS = mean(PercentSWS),
sd_SWS = sd(PercentSWS),
se_SWS = sd_SWS/sqrt(n),
mean_PS = mean(PercentPS),
sd_PS = sd(PercentPS),
se_PS = sd_PS/sqrt(n))
SumStatwt

t_wt_days <- t_wt %>%
   group_by(Transmitter, Genotype, ZT, phase) %>%
   dplyr::summarise(mean_wake = mean(PercentWake),
                    mean_sws = mean(PercentSWS),
                    mean_ps = mean(PercentPS))
```


```{r}
SumStatwt$ZT <- as.numeric(as.character(SumStatwt$ZT))

wake_plot <- ggplot(data=SumStatwt, aes(ZT, mean_Wake, color=Genotype)) +
  geom_line(aes(group=Genotype)) +
  geom_point(stat="identity", position=position_dodge(), size=2)  +
  geom_errorbar(data=SumStatwt,
                aes(x=ZT, ymin=mean_Wake-se_Wake,
                    ymax=mean_Wake+se_Wake, color=Genotype),
                width=.5) +
  scale_y_continuous(labels = scales::percent,
                     name = "Average % Time Spent Awake",
                     limits = c(0.1,0.9)) +
  scale_x_continuous(limits=c(-1,24), breaks = seq(from=0, to=23, by=2)) +
  annotate("rect", xmin=12, xmax=23, ymin=-Inf, ymax=Inf,
           alpha=0.2, fill="black") +
  theme_bw()

#ggsave("../figures/wake_plot.svg", plot=wake_plot, height=4, width=7)

sleep_plot <- ggplot(data=SumStatwt, aes(ZT, mean_Sleep, color=Genotype)) +
  geom_line(aes(group=Genotype)) +
  geom_point(stat="identity", position=position_dodge(), size=2) +
  geom_errorbar(data=SumStatwt,
                aes(x=ZT, ymin=mean_Sleep-se_Sleep,
                    ymax=mean_Sleep+se_Sleep, color=Genotype),
                width=.5) +
  scale_y_continuous(labels = scales::percent,
                     name = "Average % Time Spent Asleep",
                     limits = c(0.15,0.9)) +
  scale_x_continuous(limits=c(-1,24), breaks = seq(from=0, to=23, by=2)) +
  annotate("rect", xmin=12, xmax=23, ymin=-Inf, ymax=Inf,
           alpha=0.2, fill="black") +
  theme_bw()

#ggsave("../figures/sleep_plot.svg", plot=sleep_plot, height=4, width=7)

sws_plot <- ggplot(data=SumStatwt, aes(ZT, mean_SWS, color=Genotype)) +
  geom_line(aes(group=Genotype)) +
  geom_point(stat="identity", position=position_dodge(), size=2)  +
  geom_errorbar(data=SumStatwt,
                aes(x=ZT, ymin=mean_SWS-se_SWS,
                    ymax=mean_SWS+se_SWS, color=Genotype),
                width=.5) +
  scale_y_continuous(labels = scales::percent,
                     name = "Average % Time Spent in SWS",
                     limits = c(0.1,0.85)) +
  scale_x_continuous(limits=c(-1,24), breaks = seq(from=0, to=23, by=2)) +
  annotate("rect", xmin=12, xmax=23, ymin=-Inf, ymax=Inf,
           alpha=0.2, fill="black") +
  theme_bw()

#ggsave("../figures/sws_plot.svg", plot=sws_plot, height=4, width=7)

ps_plot <- ggplot(data=SumStatwt, aes(ZT, mean_PS, color=Genotype)) +
  geom_line(aes(group=Genotype)) +
  geom_point(stat="identity", position=position_dodge(), size=2)  +
  geom_errorbar(data=SumStatwt,
                aes(x=ZT, ymin=mean_PS-se_PS,
                    ymax=mean_PS+se_PS, color=Genotype),
                width=.5) +
  scale_y_continuous(labels = scales::percent,
                     name = "Average % Time Spent in Paradoxical Sleep",
                     limits = c(0.02,0.1)) +
  scale_x_continuous(limits=c(-1,24), breaks = seq(from=0, to=23, by=2)) +
  annotate("rect", xmin=12, xmax=23, ymin=-Inf, ymax=Inf,
           alpha=0.2, fill="black") +
  theme_bw()

#ggsave("../figures/ps_plot.png", plot=ps_plot, height=4, width=7)
```

```{r}
SumStatwtp <- dplyr::summarise(group_by(t_wt, Genotype, phase),
n = n(),
mean_Wake = mean(PercentWake),
sd_Wake = sd(PercentWake),
se_Wake = sd_Wake/sqrt(n),
mean_SWS = mean(PercentSWS),
sd_SWS = sd(PercentSWS),
se_SWS = sd_SWS/sqrt(n),
mean_PS = mean(PercentPS),
sd_PS = sd(PercentPS),
se_PS = sd_PS/sqrt(n))
SumStatwtp

t_wtp <- t_wt %>%
  group_by(Transmitter, Genotype, phase)%>%
  dplyr::summarise(mean_wake = mean(PercentWake),
                   mean_sws = mean(PercentSWS),
                   mean_ps = mean(PercentPS),
                   mean_art = mean(PercentArt))

phase_sumstats <- t_wtp %>% group_by(Genotype, phase) %>% 
  summarise(n = n(),
            mean_wake_perc = mean(mean_wake),
            sd_wake_perc = sd(mean_wake),
            mean_sws_perc = mean(mean_sws),
            sd_sws_perc = sd(mean_sws),
            mean_ps_perc = mean(mean_ps),
            sd_ps_perc = sd(mean_ps))
phase_sumstats

temp <- t_wt %>%
  group_by(Transmitter, Genotype)%>%
  dplyr::summarise(mean_wake = mean(PercentWake),
                   mean_sws = mean(PercentSWS),
                   mean_ps = mean(PercentPS),
                   mean_Art = mean(PercentArt))

max(temp$mean_Art)

temp %>% group_by(Genotype) %>% 
  summarise(n = n(),
            wake_perc = mean(mean_wake),
            sd_wake = sd(mean_wake),
            sws_perc = mean(mean_sws),
            sd_sws = sd(mean_sws),
            ps_perc = mean(mean_ps),
            sd_ps = sd(mean_ps))




#ggplot() + 
#  geom_bar(data=SumStatwtp, aes(phase, mean_Wake,fill=Genotype), stat="identity", position=position_dodge(width=0.5), width=0.5) +
#  geom_errorbar(data=SumStatwtp, aes(x=phase,ymin=mean_Wake - se_Wake, ymax=mean_Wake + se_Wake, fill=Genotype), position=position_dodge(width=0.5), width=.2,) + 
#  geom_point(data=t_wtp, aes(x=phase, y=mean_wake, fill=Genotype), position=position_dodge(width=0.5)) + scale_y_continuous(labels = scales::percent) + theme_bw()

#ggplot() + 
#  geom_bar(data=SumStatwtp, aes(phase, mean_Sleep,fill=Genotype), stat="identity", position=position_dodge(width=0.5), width=0.5) +
#  geom_errorbar(data=SumStatwtp, aes(x=phase,ymin=mean_Sleep - se_Sleep, ymax=mean_Sleep + se_Sleep, fill=Genotype), position=position_dodge(width=0.5), width=.2,) + 
#  geom_point(data=t_wtp, aes(x=phase, y=mean_sleep, fill=Genotype), position=position_dodge(width=0.5)) + scale_y_continuous(labels = scales::percent) + theme_bw()
```

```{r}
t_wt$ZT <- as.factor(t_wt$ZT)

t_wt$phase <- as.factor(t_wt$phase)
t_wt$Genotype <- as.factor(t_wt$Genotype)
t_wt_days$phase <- as.factor(t_wt_days$phase)
t_wt_days$Genotype <- as.factor(t_wt_days$Genotype)
t_wt_days$Transmitter <- as.factor(t_wt_days$Transmitter)

#over entire day
wake_day <- wilcox.test(mean_wake ~ Genotype, data= t_wt_days)
wake_day

sleep_day <- wilcox.test(mean_sleep ~ Genotype, data=t_wt_days)
sleep_day

sws_day <- wilcox.test(mean_sws ~ Genotype, data=t_wt_days)
sws_day

ps_day <- wilcox.test(mean_ps ~ Genotype, data=t_wt_days)
ps_day

#by phase
lmer_wake <- lmer(mean_wake ~ phase*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_wake, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_wake)
anova(lmer_wake)
car::Anova(lmer_wake, type="3")
emmeans::emmeans(lmer_wake, pairwise ~ Genotype | phase)$contrasts
emmeans::emmeans(lmer_wake, pairwise ~ phase | Genotype)$contrasts

lmer_sws <- lmer(mean_sws ~ phase*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_sws, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_sws)
anova(lmer_sws)
#emmeans::emmeans(lmer_sws, pairwise ~ Genotype | phase)$contrasts
emmeans::emmeans(lmer_sws, pairwise ~ phase | Genotype)$contrasts

lmer_ps <- lmer(mean_ps ~ phase*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_ps, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_ps)
anova(lmer_ps)
#emmeans::emmeans(lmer_ps, pairwise ~ Genotype | phase)$contrasts
emmeans::emmeans(lmer_ps, pairwise ~ phase | Genotype)$contrasts

#by ZT
t_wt_days$ZT <- as.factor(t_wt_days$ZT)

lmer_wake_zt <- lmer(mean_wake ~ ZT*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_wake_zt, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_wake_zt)
anova(lmer_wake_zt)
#emmeans::emmeans(lmer_wake_zt, pairwise ~ ZT | Genotype)
emmeans::emmeans(lmer_wake_zt, pairwise ~  Genotype | ZT)$contrasts

lmer_sleep_zt <- lmer(mean_sleep ~ ZT*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_sleep_zt, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_sleep_zt)
anova(lmer_sleep_zt)
#emmeans::emmeans(lmer_sleep_zt, pairwise ~ ZT | Genotype)
emmeans::emmeans(lmer_sleep_zt, pairwise ~  Genotype | ZT)$contrasts

lmer_sws_zt <- lmer(mean_sws ~ ZT*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_sws_zt, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_sws_zt)
anova(lmer_sws_zt)
#emmeans::emmeans(lmer_sws_zt, pairwise ~ ZT | Genotype)
emmeans::emmeans(lmer_sws_zt, pairwise ~  Genotype | ZT)$contrasts

lmer_ps_zt <- lmer(mean_ps ~ ZT*Genotype+(1|Transmitter), data = t_wt_days)
#plot(lmer_ps_zt, type=c("p","smooth"), col.line=1)
#lattice::qqmath(lmer_ps_zt)
anova(lmer_ps_zt)
#emmeans::emmeans(lmer_ps_zt, pairwise ~ ZT | Genotype)
emmeans::emmeans(lmer_ps_zt, pairwise ~  Genotype | ZT)$contrasts
```


```{r, include=FALSE, echo=FALSE}
#ggplot(data=t_wt, aes(ZT, PercentWake, color=Genotype)) + geom_line(aes(group=Transmitter)) + geom_point() + scale_y_continuous(labels = scales::percent)

#ggplot(data=t_wt, aes(ZT, PercentWake, color=Genotype)) + geom_line(aes(group=1)) + geom_point(stat="identity", position=position_dodge(), size=2) + facet_wrap(~Transmitter, ncol=4) + scale_y_continuous(labels = scales::percent)

#ggplot(data=t_wt, aes(ZT, PercentSleep, color=Genotype)) + geom_line(aes(group=Transmitter)) + geom_point()+ scale_y_continuous(labels = scales::percent)

#ggplot(data=t_wt, aes(ZT, PercentSleep, color=Genotype)) + geom_line(aes(group=1)) + geom_point(stat="identity", position=position_dodge(), size=2) + facet_wrap(~Transmitter, ncol = 4) + scale_y_continuous(labels = scales::percent)
```
