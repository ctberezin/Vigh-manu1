---
title: "Analysis of B-endorphin/ChAT IHC Count Data"
author: "C-T Berezin"
date: "11/21/2021"
output:
  pdf_document: default
  html_document: default
---

```{r, message = FALSE, warning = FALSE}
library(knitr)
library(tidyverse)
library(dplyr)
library(WebPower)
library(ggpubr)
library(car)
```


```{r}
counts <- read_csv("../data/B-endo-totals.csv")
counts <- counts %>%
  dplyr::select(-ChAT, -Bendo, -Percentage) %>%
  #make columns lowercase
  rename(mouse = Mouse,
        light = Light,
        time = Time,
        sex = Sex,
        age = Age,
        GCL_chat = GCLchat,
        GCL_bendo = GCLbendo,
        INL_chat = INLchat,
        INL_bendo = INLbendo) %>%
  #update the classes of some columns
  mutate(mouse = as.character(mouse),
         light = factor(as.factor(light), levels=c("light", "dark")),
         time = as.factor(time),
  #reintroduce total counts
         total_chat = GCL_chat+INL_chat,
         total_bendo = GCL_bendo+INL_bendo) %>%
  #calculate percentages
  mutate(GCL_perc=GCL_bendo/GCL_chat*100,
         INL_perc=INL_bendo/INL_chat*100,
         total_perc=total_bendo/total_chat*100)

```

```{r}
#checking if the cell counts are normally distributed
shapiro.test(counts$INL_chat)
shapiro.test(counts$INL_bendo)
shapiro.test(counts$GCL_chat)
shapiro.test(counts$GCL_bendo)
shapiro.test(counts$total_chat)
shapiro.test(counts$total_bendo)
```

```{r}
manset <- counts %>% dplyr::select(light:time, GCL_perc:INL_perc)

#testing manova assumptions
#multivariate normality
#normal distribution for each combo of indep and dependent variables
percs %>% filter(light == "light" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)
percs %>% filter(light == "dark" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)

percs %>% filter(light == "light" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
percs %>% filter(light == "dark" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)

percs %>% filter(time == "day" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)
percs %>% filter(time == "night" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)

percs %>% filter(time == "day" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
percs %>% filter(time == "night" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
#all pass


percs %>% filter(light == "light" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)

#checking homogenous variance in each combo
#null hyp is that variance is equal
car::leveneTest(manset$GCL_perc, group=manset$light)
car::leveneTest(manset$INL_perc, group=manset$light)
car::leveneTest(manset$GCL_perc, group=manset$time)
car::leveneTest(manset$INL_perc, group=manset$time)


#checking for multicollinearity
#low values are good
inllm <- lm(INL_perc ~ light * time, manset)
car::vif(inllm)
gcllm <- lm(GCL_perc ~ light * time, manset)
car::vif(gcllm)

#linearity of dep variables
plot(manset$GCL_perc, manset$INL_perc)

#good to go on manova!
```


```{r}
#manova
mantest <- manova(cbind(GCL_perc, INL_perc) ~ light * time, data=manset)
summary(mantest)
summary.aov(mantest)
#light:time interaction is significant overall and for GCL and INL
#look at comparisons through univariate models for each dep variable
summary(gcllm)
summary(inllm)
```

```{r}
plotting_manset <- counts %>%
  dplyr::select(mouse,light:time, GCL_perc:INL_perc)

gclplotmanset <- plotting_manset %>% 
  mutate(mouse = fct_reorder(as.factor(mouse), GCL_perc,
                      .fun=max, .desc=FALSE))

gclplot <- gclplotmanset %>% ggplot(aes(x=mouse, y=GCL_perc)) +
  geom_bar(stat="identity") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  expand_limits(y=c(0,38)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank()) +
  labs(y="Ganglion cell layer")

inlplotmanset <- plotting_manset %>% 
  mutate(mouse = fct_reorder(as.factor(mouse), INL_perc,
                      .fun=max, .desc=FALSE))

inlplot <- inlplotmanset %>% ggplot(aes(x=mouse, y=INL_perc)) +
  geom_bar(stat="identity") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  expand_limits(y=c(0,38)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank()) +
  labs(y="Inner nuclear layer")

ggarrange(gclplot, inlplot, nrow=2)
```





```{r}
#data setup for previous anova analysis
anovpercs <- counts %>%
  #give one row for each GCL, INL, and total
  #retain only the percentages, not the raw counts
  dplyr::select(-c(GCL_chat:total_bendo)) %>% 
  pivot_longer(GCL_perc:total_perc,
               names_to="type",
               values_to="perc") %>%
  separate(type, sep="_", into=c("layer", "protein")) %>% 
  dplyr::select(-protein) %>% 
  mutate(layer = as.factor(layer),
         mouse = fct_reorder(as.factor(mouse), perc,
                              .fun=max, .desc=FALSE),
         time = as.factor(time)) %>% 
  filter(layer != "total")
head(anovpercs, 3)
```

```{r}
aov <- aov(perc ~ light * time * layer, anovpercs)
summary(aov)
TukeyHSD(aov)
```

```{r}
#set up a table of p-values for labeling the graphs below
label <- tibble(mouse = c("97", "93", "57"),
                perc = c(Inf, Inf, Inf),
                time = c("day", "night", "night"),
                light = c("dark", "light", "dark"),
                label = c("p=0.00009", "p=0.0058", "p=0.037"))
```


```{r}
#1 row facet wrap, small
bendo_ihc <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer",
       title = "Figure 2") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=4),
        plot.title = element_text(size=4, margin=margin(0,0,0,0), face = "bold"),
        legend.key.size = unit(0.25, 'cm'),
        strip.text.x = element_text(size = 3, margin = margin(0, 0, 0.02, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=1)

ggsave(filename="../figures/bendo_ihc.png", plot=bendo_ihc, height=1, width=2.5)
```

```{r}
#1 row facet wrap, large
bendo_ihc_large <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=16),
        legend.key.size = unit(1, 'cm'),
        strip.text.x = element_text(size = 16, margin = margin(0.2, 0, 0.2, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  expand_limits(y=c(0,45))
  #geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=6)

bendo_ihc_large

ggsave(filename="../figures/bendo_ihc_large_nostats.png", plot=bendo_ihc_large, height=5, width=12)
```

```{r}
#2 BY 2 FACET WRAP
bendo_ihc_boxy <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=2, as.table=TRUE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=4),
        plot.title = element_text(size=4, margin=margin(0,0,0,0), face = "bold"),
        legend.key.size = unit(0.25, 'cm'),
        strip.text.x = element_text(size = 3, margin = margin(0, 0, 0.02, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=1)

ggsave(filename="../figures/bendo_ihc_boxy.png", plot=bendo_ihc_boxy, height=4, width=4)
```
