---
title: "Analysis of B-endorphin/ChAT IHC Count Data"
author: "C-T Berezin"
date: "11/21/2021"
output:
  pdf_document: default
  html_document: default
---

```{r, message = FALSE, warning = FALSE}
library(knitr)
library(tidyverse)
library(dplyr)
library(WebPower)
library(ggpubr)
library(car)
library(ggthemes)
library(viridis)
```

## Reading in and Tidying the Data

```{r}
counts <- read_csv("../data/B-endo-totals.csv")
counts <- counts %>%
  dplyr::select(-ChAT, -Bendo, -Percentage) %>%
  #make columns lowercase
  rename(mouse = Mouse,
        light = Light,
        time = Time,
        sex = Sex,
        age = Age,
        GCL_chat = GCLchat,
        GCL_bendo = GCLbendo,
        INL_chat = INLchat,
        INL_bendo = INLbendo) %>%
  #update the classes of some columns
  mutate(mouse = as.factor(mouse),
         light = factor(as.factor(light), levels=c("light", "dark")),
         time = as.factor(time),
  #reintroduce total counts
         total_chat = GCL_chat+INL_chat,
         total_bendo = GCL_bendo+INL_bendo) %>%
  #calculate percentages
  mutate(GCL_perc=GCL_bendo/GCL_chat*100,
         INL_perc=INL_bendo/INL_chat*100,
         total_perc=total_bendo/total_chat*100)
counts

```

```{r}
#manova for ChAT cells per mm2
counts <- counts %>% mutate(
  GCL_chat_mm = GCL_chat/Area,
  GCL_bendo_mm = GCL_bendo/Area,
  INL_chat_mm = INL_chat/Area,
  INL_bendo_mm = INL_bendo/Area
)

counts_temp <- counts %>% filter(!is.na(GCL_chat_mm))

counts_temp %>% summarise(
  min_INL_chat_mm = min(INL_chat_mm),
  mean_INL_chat_mm = mean(INL_chat_mm),
  max_INL_chat_mm = max(INL_chat_mm),
  min_GCL_chat_mm = min(GCL_chat_mm),
  mean_GCL_chat_mm = mean(GCL_chat_mm),
  max_GCL_chat_mm = max(GCL_chat_mm)
)

shapiro.test(counts_temp$GCL_chat_mm)
shapiro.test(counts_temp$INL_chat_mm)

counts_temp_long <- counts_temp %>%
  #give one row for each GCL, INL, and total
  #retain only the percentages, not the raw counts
  dplyr::select(-c(GCL_chat:INL_bendo, total_chat:total_perc)) %>% 
  pivot_longer(GCL_chat_mm:INL_bendo_mm,
               names_to="type",
               values_to="cells_mm") %>%
  separate(type, sep="_", into=c("layer", "protein", "size")) %>% 
  dplyr::select(-size) %>% 
  mutate(layer = as.factor(layer),
         protein = as.factor(protein))

#testing manova assumptions
#multivariate normality
#normal distribution for each combo of indep and dependent variables
counts_temp_long %>% filter(layer =="GCL" & protein == "chat" & time == "day") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="GCL" & protein == "chat" & time == "night") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "chat" & time == "day") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "chat" & time == "night") %>% pull(cells_mm) %>% shapiro.test(.)

counts_temp_long %>% filter(layer =="GCL" & protein == "chat" & light == "light") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="GCL" & protein == "chat" & light == "dark") %>% pull(cells_mm) %>% shapiro.test(.)
#re-run with last sample
counts_temp_long %>% filter(layer =="INL" & protein == "chat" & time == "light") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "chat" & time == "dark") %>% pull(cells_mm) %>% shapiro.test(.)

#checking homogenous variance in each combo
car::leveneTest(counts_temp$GCL_chat_mm, group=counts_temp$light)
car::leveneTest(counts_temp$INL_chat_mm, group=counts_temp$light)
car::leveneTest(counts_temp$GCL_chat_mm, group=counts_temp$time)
car::leveneTest(counts_temp$INL_chat_mm, group=counts_temp$time)

#checking for multicollinearity
#low values are good
inllm <- lm(INL_chat_mm ~ light * time, counts_temp)
car::vif(inllm)
gcllm <- lm(GCL_chat_mm ~ light * time, counts_temp)
car::vif(gcllm)

#linearity of dep variables
plot(counts_temp$GCL_chat_mm, counts_temp$INL_chat_mm)
abline(150,1)

#good to go on manova!

#manova
mantest <- manova(cbind(GCL_chat_mm, INL_chat_mm) ~ light * time, data=counts_temp)
summary(mantest)
summary.aov(mantest)
#light:time interaction is significant overall and for GCL and INL
#look at comparisons through univariate models for each dep variable
anova(gcllm)
anova(inllm)
```

```{r}
#manova for bendo cells per mm2
counts_temp %>% group_by(light, time) %>% summarise(
  min_INL_bendo_mm = min(INL_bendo_mm),
  mean_INL_bendo_mm = mean(INL_bendo_mm),
  max_INL_bendo_mm = max(INL_bendo_mm),
  min_GCL_bendo_mm = min(GCL_bendo_mm),
  mean_GCL_bendo_mm = mean(GCL_bendo_mm),
  max_GCL_bendo_mm = max(GCL_bendo_mm)
)

shapiro.test(counts_temp$GCL_bendo_mm)
shapiro.test(counts_temp$INL_bendo_mm)

#testing manova assumptions
#multivariate normality
#normal distribution for each combo of indep and dependent variables
counts_temp_long %>% filter(layer =="GCL" & protein == "bendo" & time == "day") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="GCL" & protein == "bendo" & time == "night") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "bendo" & time == "day") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "bendo" & time == "night") %>% pull(cells_mm) %>% shapiro.test(.)

counts_temp_long %>% filter(layer =="GCL" & protein == "bendo" & light == "light") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="GCL" & protein == "bendo" & light == "dark") %>% pull(cells_mm) %>% shapiro.test(.)
#re-run with last sample
counts_temp_long %>% filter(layer =="INL" & protein == "bendo" & time == "light") %>% pull(cells_mm) %>% shapiro.test(.)
counts_temp_long %>% filter(layer =="INL" & protein == "bendo" & time == "dark") %>% pull(cells_mm) %>% shapiro.test(.)

#checking homogenous variance in each combo
car::leveneTest(counts_temp$GCL_bendo_mm, group=counts_temp$light)
car::leveneTest(counts_temp$INL_bendo_mm, group=counts_temp$light)
car::leveneTest(counts_temp$GCL_bendo_mm, group=counts_temp$time)
car::leveneTest(counts_temp$INL_bendo_mm, group=counts_temp$time)

#checking for multicollinearity
#low values are good
inl_bendo_lm <- lm(INL_bendo_mm ~ light * time, counts_temp)
car::vif(inl_bendo_lm)
gcl_bendo_lm <- lm(GCL_bendo_mm ~ light * time, counts_temp)
car::vif(gcl_bendo_lm)

#linearity of dep variables
plot(counts_temp$GCL_bendo_mm, counts_temp$INL_bendo_mm)
abline(25,2)

#good to go on manova!

#manova
man_bendo_test <- manova(cbind(GCL_bendo_mm, INL_bendo_mm) ~ light * time, data=counts_temp)
summary(man_bendo_test)
summary.aov(man_bendo_test)
#light:time interaction is just about significant overall and for GCL and INL
#look at comparisons through univariate models for each dep variable
anova(gcl_bendo_lm)
summary(gcl_bendo_lm)
anova(inl_bendo_lm)
summary(inl_bendo_lm)
emmeans::emmeans(gcl_bendo_lm, pairwise ~ light * time, adjust="none")$contrasts
emmeans::emmeans(gcl_bendo_lm, dunnett ~ light * time)$contrasts
emmeans::emmeans(gcl_bendo_lm, pairwise ~ light * time)$contrasts

emmeans::emmeans(inl_bendo_lm, pairwise ~ light * time, adjust="none")$contrasts
emmeans::emmeans(inl_bendo_lm, dunnett ~ light * time)$contrasts
emmeans::emmeans(inl_bendo_lm, pairwise ~ light * time)$contrasts
```


```{r}
#data setup for previous anova analysis
#also used in manova shapiro tests for ease
anovpercs <- counts %>%
  #give one row for each GCL, INL, and total
  #retain only the percentages, not the raw counts
  dplyr::select(-c(GCL_chat:total_bendo)) %>% 
  pivot_longer(GCL_perc:total_perc,
               names_to="type",
               values_to="perc") %>%
  separate(type, sep="_", into=c("layer", "protein")) %>% 
  dplyr::select(-protein) %>% 
  mutate(layer = as.factor(layer),
         mouse = fct_reorder(as.factor(mouse), perc,
                              .fun=max, .desc=FALSE),
         time = as.factor(time)) %>% 
  filter(layer != "total")
head(anovpercs, 2)
```

## Checking Normality

```{r}
#checking if the cell counts are normally distributed
shapiro.test(counts$INL_chat)
shapiro.test(counts$INL_bendo)
shapiro.test(counts$GCL_chat)
shapiro.test(counts$GCL_bendo)
shapiro.test(counts$total_chat)
shapiro.test(counts$total_bendo)
```

## Checking MANOVA Assumptions

```{r}
manset <- counts %>% dplyr::select(light:time, GCL_perc:INL_perc)

#testing manova assumptions
#multivariate normality
#normal distribution for each combo of indep and dependent variables
anovpercs %>% filter(light == "light" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)
anovpercs %>% filter(light == "dark" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)

anovpercs %>% filter(light == "light" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
anovpercs %>% filter(light == "dark" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)

anovpercs %>% filter(time == "day" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)
anovpercs %>% filter(time == "night" & layer =="GCL") %>% pull(perc) %>% shapiro.test(.)

anovpercs %>% filter(time == "day" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
anovpercs %>% filter(time == "night" & layer =="INL") %>% pull(perc) %>% shapiro.test(.)
#all pass


#checking homogenous variance in each combo
#null hyp is that variance is equal
car::leveneTest(manset$GCL_perc, group=manset$light)
car::leveneTest(manset$INL_perc, group=manset$light)
car::leveneTest(manset$GCL_perc, group=manset$time)
car::leveneTest(manset$INL_perc, group=manset$time)


#checking for multicollinearity
#low values are good
inllm <- lm(INL_perc ~ light * time, manset)
car::vif(inllm)
gcllm <- lm(GCL_perc ~ light * time, manset)
car::vif(gcllm)

#linearity of dep variables
plot(manset$GCL_perc, manset$INL_perc)

#good to go on manova!
```

## MANOVA

```{r}
#manova
mantest <- manova(cbind(GCL_perc, INL_perc) ~ light * time, data=manset)
summary(mantest)
summary.aov(mantest)
#light:time interaction is significant overall and for GCL and INL
#look at comparisons through univariate models for each dep variable
summary(gcllm)
summary(inllm)

emmeans::emmeans(gcllm, pairwise ~ light * time, adjust="none")$contrasts
emmeans::emmeans(gcllm, dunnett ~ light * time)$contrasts
emmeans::emmeans(gcllm, pairwise ~ light * time)$contrasts
```

## Plotting 

```{r}
plotting_manset <- counts %>%
  dplyr::select(mouse,light:time, GCL_perc:INL_perc)


plotting_manset$group <- c("1", "1", "1", "2", "2", "2", "3", "3", "3", "4", "4", "4")


inlpointmanset <- plotting_manset %>% 
  mutate(mouse = fct_reorder(as.factor(mouse), INL_perc,
                      .fun=max, .desc=FALSE))

inlpointplot <- inlpointmanset %>% ggplot(aes(x=group, y=INL_perc, fill=light)) +
  stat_summary(fun = 'mean', geom="bar") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=.2) +
  geom_point(size =2) +
  facet_wrap(time ~ factor(light, c("light", "dark")),
             scales="free_x",
             nrow=1,
             as.table=FALSE) +
  theme_bw() %+replace%
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(0,"pt"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        panel.background = element_rect(fill = "transparent",colour = NA)) +
  labs(y="Inner nuclear layer") +
  scale_y_continuous(labels=function(x) paste0(x,"%"),
                     limits=c(0,40),
                     expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values=c("yellow", "gray70"))


gclpointmanset <- plotting_manset %>% 
  mutate(mouse = fct_reorder(as.factor(mouse), GCL_perc,
                      .fun=max, .desc=FALSE))

gclpointplot <- gclpointmanset %>% ggplot(aes(x=group, y=GCL_perc, fill=light)) +
  stat_summary(fun = 'mean', geom="bar") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=.2) +
  geom_point(size=2) +
  facet_wrap(time ~ factor(light, c("light", "dark")),
             scales="free_x",
             nrow=1,
             as.table=FALSE) +
  theme_bw() %+replace%
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        panel.spacing = unit(0, "pt"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        panel.background = element_rect(fill = "transparent",colour = NA)) +
  labs(y="Ganglion cell layer") +
  scale_y_continuous(labels=function(x) paste0(x,"%"),
                     limits=c(0,30),
                     expand = expansion(mult = c(0, 0))) +
  scale_fill_manual(values=c("yellow", "gray70"))

bothpointplots <- ggarrange(inlpointplot, gclpointplot, nrow=2)

bothpointplots
ggsave("../figures/manova_bendo_ihc.png", plot=bothpointplots, width=6, height=6, bg = "transparent")
```



### Old ANOVA analysis

```{r}
aov <- aov(perc ~ light * time * layer, anovpercs)
summary(aov)
TukeyHSD(aov)
```

```{r}
#set up a table of p-values for labeling the graphs below
label <- tibble(mouse = c("97", "93", "57"),
                perc = c(Inf, Inf, Inf),
                time = c("day", "night", "night"),
                light = c("dark", "light", "dark"),
                label = c("p=0.00009", "p=0.0058", "p=0.037"))
```


```{r}
#1 row facet wrap, small
bendo_ihc <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer",
       title = "Figure 2") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=4),
        plot.title = element_text(size=4, margin=margin(0,0,0,0), face = "bold"),
        legend.key.size = unit(0.25, 'cm'),
        strip.text.x = element_text(size = 3, margin = margin(0, 0, 0.02, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=1)

#ggsave(filename="../figures/bendo_ihc.png", plot=bendo_ihc, height=1, width=2.5)
```

```{r}
#1 row facet wrap, large
bendo_ihc_large <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=1, as.table=FALSE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=16),
        legend.key.size = unit(1, 'cm'),
        strip.text.x = element_text(size = 16, margin = margin(0.2, 0, 0.2, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  expand_limits(y=c(0,45))
  #geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=6)

bendo_ihc_large

#ggsave(filename="../figures/bendo_ihc_large_nostats.png", plot=bendo_ihc_large, height=5, width=12)
```

```{r}
#2 BY 2 FACET WRAP
bendo_ihc_boxy <- anovpercs %>% ggplot(aes(x=mouse, y=perc)) +
  geom_bar(aes(fill=layer), stat="identity", position="dodge") +
  facet_wrap(time ~ factor(light, c("light", "dark")), scales="free_x", nrow=2, as.table=TRUE) +
  labs(y="% of B-endorphin+ ChAT cells",
       col="Light Condition", shape="Cell Layer") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size=4),
        plot.title = element_text(size=4, margin=margin(0,0,0,0), face = "bold"),
        legend.key.size = unit(0.25, 'cm'),
        strip.text.x = element_text(size = 3, margin = margin(0, 0, 0.02, 0, "cm")),
        axis.ticks = element_blank(),
        legend.margin=margin(0,0,0,0)) +
  scale_fill_manual(values = c("yellow", "cornflowerblue", "grey50")) +
  geom_text(aes(label=label), data=label, vjust="top", hjust="left", size=1)

#ggsave(filename="../figures/bendo_ihc_boxy.png", plot=bendo_ihc_boxy, height=4, width=4)
```